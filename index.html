<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Fit Step Count</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <button onclick="authenticate()">Authorize and Load</button>
    <button onclick="execute()">Execute</button>

    <script>
        let accessToken = '';
        const endTimeMillis = Date.now(); // Current time in milliseconds
        const startTimeMillis = endTimeMillis - (7 * 24 * 60 * 60 * 1000); // 7 days ago

        function authenticate() {
            google.accounts.oauth2.initTokenClient({
                client_id: '389074169622-1flijncf2phnpcf7somgmjejt272eubo.apps.googleusercontent.com',  // Replace with your client ID
                scope: 'https://www.googleapis.com/auth/fitness.activity.read',
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    console.log('Access Token:', accessToken);
                    loadClient();
                }
            }).requestAccessToken();
        }

        function loadClient() {
            gapi.client.setApiKey("AIzaSyApfKMexFM6BYlXU5_soJtqM5gaXEmVXCk");  // Replace with your API key
            return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/fitness/v1/rest")
                .then(function() { 
                    console.log("GAPI client loaded for API");
                },
                function(err) { 
                    console.error("Error loading GAPI client for API", err); 
                });
        }

        function execute() {
            if (!gapi.client.fitness) {
                console.error("Google Fit API client is not initialized. Please load the client first.");
                return;
            }

            gapi.client.fitness.users.dataset.aggregate({
                "userId": "me",
                "resource": {
                    "aggregateBy": [
                        {
                            "dataTypeName": "com.google.step_count.delta",
                            "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps"
                        }
                    ],
                    "startTimeMillis": startTimeMillis,
                    "endTimeMillis": endTimeMillis,
                    "bucketByTime": {
                        "durationMillis": 86400000 // 1 day in milliseconds
                    }
                }
            })
            .then(function(response) {
                    console.log("Response", response);
                    if (response.result.bucket && response.result.bucket.length > 0) {
                        console.log("Data received: ", response.result.bucket);
                        response.result.bucket.forEach(bucket => {
                            const stepCount = bucket.dataset[0].point.reduce((sum, point) => sum + point.value[0].intVal, 0);
                            console.log(`Steps on ${new Date(parseInt(bucket.startTimeMillis)).toDateString()}: ${stepCount}`);
                        });
                    } else {
                        console.log("No data available for the given time range.");
                    }
                },
                function(err) { 
                    console.error("Execute error", err); 
                });
        }
    </script>
</body>
</html>
