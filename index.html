<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Fit Step Count</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div id="g_id_onload"
         data-client_id="389074169622-1flijncf2phnpcf7somgmjejt272eubo.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>

    <button onclick="authenticate()">Authorize and Load</button>

    <script>
        function handleCredentialResponse(response) {
            console.log('Encoded JWT ID token: ' + response.credential);
            // You can send the ID token to your server for verification and further processing.
        }

        function authenticate() {
            google.accounts.oauth2.initTokenClient({
                client_id: '389074169622-1flijncf2phnpcf7somgmjejt272eubo.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/fitness.activity.read',
                callback: (tokenResponse) => {
                    console.log('Access Token: ', tokenResponse.access_token);
                    loadClient(tokenResponse.access_token);
                }
            }).requestAccessToken();
        }

        function loadClient(accessToken) {
            gapi.client.setApiKey("AIzaSyApfKMexFM6BYlXU5_soJtqM5gaXEmVXCk");
            gapi.client.load("https://content.googleapis.com/discovery/v1/apis/fitness/v1/rest")
                .then(function() { 
                    console.log("GAPI client loaded for API");
                    execute(accessToken);
                },
                function(err) { 
                    console.error("Error loading GAPI client for API", err); 
                });
        }

        function execute(accessToken) {
            gapi.client.fitness.users.dataset.aggregate({
                "userId": "me",
                "resource": {
                    "aggregateBy": [
                        {
                            "dataTypeName": "com.google.step_count.delta",
                            "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps"
                        }
                    ],
                    "endTimeMillis": 1561652514300,
                    "startTimeMillis": 1561228200000,
                    "bucketByTime": {
                        "durationMillis": 86400000
                    }
                }
            })
            .then(function(response) {
                console.log("Response", response);
            }, function(err) { 
                console.error("Execute error", err); 
            });
        }
    </script>
</body>
</html>
